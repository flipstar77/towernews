# RAG System Configuration
# Central configuration for the Tower News RAG system

# Storage Backend
storage:
  # Options: "supabase" (production), "local" (development)
  backend: "supabase"

  # Supabase settings (uses env vars SUPABASE_URL, SUPABASE_KEY)
  supabase:
    table_name: "tower_knowledge"

  # Local storage settings
  local:
    data_dir: "data/knowledge_base"

# Embedding Settings
embeddings:
  # Use local embeddings (sentence-transformers) instead of OpenAI
  use_local: false

  # OpenAI model (when use_local=false)
  openai_model: "text-embedding-3-small"
  openai_dimensions: 1536

  # Local model (when use_local=true)
  local_model: "all-MiniLM-L6-v2"
  local_dimensions: 384

# Chunking Configuration
chunking:
  # Default chunk settings
  default:
    max_size: 800        # Maximum characters per chunk
    overlap: 0.15        # 15% overlap between chunks
    min_size: 100        # Minimum chunk size
    respect_sentences: true

  # Per document type overrides (multiplier on max_size)
  type_multipliers:
    post: 1.0
    comment: 0.5         # Shorter chunks for comments
    wiki: 1.25           # Longer for wiki content
    guide: 1.5           # Longest for guides

# Search Configuration
search:
  # Hybrid search weights
  semantic_weight: 0.6
  fulltext_weight: 0.4

  # Enable re-ranking (Phase 5 feature)
  use_reranking: false
  reranking_model: "cross-encoder/ms-marco-MiniLM-L-6-v2"

  # Default search limit
  default_limit: 10

  # Minimum similarity threshold
  min_similarity: 0.3

# Boosting Configuration
boosting:
  # Document type boosts
  type_boosts:
    guide: 1.3
    wiki: 1.25
    post: 1.0
    comment: 0.9

  # Flair boosts (Reddit)
  flair_boosts:
    Guide: 1.3
    Info: 1.2
    Discussion: 1.1
    Help: 1.0
    Question: 1.0
    Achievement: 0.9
    Meme: 0.7

  # Score boost (for high Reddit scores)
  high_score:
    threshold: 100       # Reddit score threshold
    multiplier: 1.2

  # Recency boost
  recency:
    days: 90             # Posts newer than this get boosted
    multiplier: 1.15

# Query Processing
query:
  # Path to glossary file
  glossary_path: "config/tower_glossary.yaml"

  # Enable abbreviation expansion
  expand_abbreviations: true

  # Enable typo correction
  fix_typos: true

  # Enable synonym expansion
  expand_synonyms: false  # Can increase recall but may reduce precision

# Ingestion Settings
ingestion:
  # Reddit scraping
  reddit:
    min_delay: 2.0       # Seconds between requests
    user_agent: "TowerNews/1.0 (Knowledge Ingester)"
    min_post_score: 5
    min_comment_score: 3
    max_comments_per_post: 50

  # Wiki scraping
  wiki:
    min_delay: 1.0
    user_agent: "TowerNews/1.0 (Wiki Scraper)"
    max_pages: 500

# Context Generation (for RAG prompts)
context:
  # Maximum tokens for context
  max_tokens: 2000

  # Format template
  template: |
    [Source {index} | {doc_type} | score: {score}]
    {content}

# Monitoring & Logging
monitoring:
  # Log search queries
  log_queries: true

  # Log slow queries (ms)
  slow_query_threshold: 500

  # Analytics storage
  analytics_dir: "data/rag_analytics"

# Database Schema (for reference/setup)
schema:
  setup_sql: |
    -- Enable extensions
    CREATE EXTENSION IF NOT EXISTS vector;
    CREATE EXTENSION IF NOT EXISTS pg_trgm;

    -- Create knowledge base table
    CREATE TABLE IF NOT EXISTS tower_knowledge (
        id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
        content TEXT NOT NULL,
        embedding vector(1536),
        metadata JSONB DEFAULT '{}',
        post_id TEXT,
        post_type TEXT,
        subreddit TEXT DEFAULT 'TheTowerGame',
        score INTEGER DEFAULT 0,
        created_at TIMESTAMPTZ DEFAULT NOW(),
        ingested_at TIMESTAMPTZ DEFAULT NOW()
    );

    -- HNSW index for fast similarity search (better than IVFFlat)
    CREATE INDEX IF NOT EXISTS tower_knowledge_embedding_hnsw_idx
    ON tower_knowledge
    USING hnsw (embedding vector_cosine_ops)
    WITH (m = 16, ef_construction = 64);

    -- Additional indexes
    CREATE INDEX IF NOT EXISTS tower_knowledge_post_id_idx ON tower_knowledge(post_id);
    CREATE INDEX IF NOT EXISTS tower_knowledge_post_type_idx ON tower_knowledge(post_type);
    CREATE INDEX IF NOT EXISTS tower_knowledge_score_idx ON tower_knowledge(score DESC);
    CREATE INDEX IF NOT EXISTS tower_knowledge_created_idx ON tower_knowledge(created_at DESC);

    -- Trigram index for fulltext search
    CREATE INDEX IF NOT EXISTS tower_knowledge_content_trgm_idx
    ON tower_knowledge USING gin (content gin_trgm_ops);

    -- Similarity search function
    CREATE OR REPLACE FUNCTION match_tower_knowledge(
        query_embedding vector(1536),
        match_count int DEFAULT 5,
        filter_metadata jsonb DEFAULT '{}'
    )
    RETURNS TABLE (
        id UUID,
        content TEXT,
        metadata JSONB,
        similarity FLOAT
    )
    LANGUAGE plpgsql
    AS $$
    BEGIN
        RETURN QUERY
        SELECT
            tk.id,
            tk.content,
            tk.metadata,
            1 - (tk.embedding <=> query_embedding) AS similarity
        FROM tower_knowledge tk
        WHERE tk.metadata @> filter_metadata
        ORDER BY tk.embedding <=> query_embedding
        LIMIT match_count;
    END;
    $$;
